<#README
SharepointReport.PS1 requires the following
	PowerShell 7.x
	PnP.PowerShell module installed
	Azure App registration for PnP.PowerShell

1. Acquire the admin URL for the SharePoint site 
For example: https://m365x60122125-admin.sharepoint.com/

2. Get the Application ID for the PnP.PowerShell module, if it exists
For example: 8dd4369c-6947-4923-8a2a-321253fb5ecd

   If this application does NOT exist, one can be created!

   Information page for PnP app registration:
   https://pnp.github.io/powershell/articles/registerapplication.html

   Automatically create an app:
   Register-PnPEntraIDAppForInteractiveLogin -ApplicationName "PnP.PSApp" -Tenant M365x60122125.onmicrosoft.com -Interactive

   When it is completed, make sure to "Consent on behalf of the organization"
   Also make note of the Application ID -- it will be in the PowerShell response.

3. Log into the admin SharePoint tenant:
Substitute the URL below with the admin URL and Application ID from the target tenant.  Trailing "/" isn't expressly necessary.

Connect-PnPOnline -Url "https://m365x60122125-admin.sharepoint.com" -Interactive -ClientId 8dd4369c-6947-4923-8a2a-321253fb5ecd

4. Gather the data for the report:
.\SharepointReport.ps1 -view 'SharePoint Sites'
This command will gather all the sites required.

This will create a <date>-<time>-SPO-Output.csv in the folder that was run for analysis!
#>

[CmdletBinding(DefaultParameterSetName = 'PSetAll')]

param (
    [Parameter(Mandatory, ParameterSetName = 'PSetSpecified')]
    [String[]]
    $URL,

    [Parameter(Mandatory, ParameterSetName = 'PSetAll')]
    [ValidateSet(
        'All Sites',
        'SharePoint Sites',
        'Microsoft 365 Group Sites',
        'Sites Connected to Teams',
        'Sites Connected to Teams Channel',
        'Sites Without a Group',
        'OneDrive Sites'
    )]
    [string]
    $View,

    [Parameter(ParameterSetName = 'PSetAll')]
    [string[]]
    $Exclude
)

$SeekOwner  = $False
$dateTime   = Get-Date
$OutputFile = $dateTime.toString("yyyyMMdd-HHmmss") + "-SPO-Output.csv"

try {
    $pnpTenantInstance = Get-PnPTenantInstance -ErrorAction Stop
    $excludedUrls = [System.Collections.ArrayList]@(
        "$($pnpTenantInstance.RootSiteUrl)"
        "$($pnpTenantInstance.RootSiteUrl)sites/appcatalog"
        "$($pnpTenantInstance.RootSiteUrl)portals/hub",
        "$($pnpTenantInstance.RootSiteUrl)search",
        "$($pnpTenantInstance.MySiteHostUrl)",
        "$($pnpTenantInstance.TenantAdminUrl)"
    )

    if ($Exclude) {
        $excludedUrls.AddRange($Exclude)
    }
}
catch {
    $_.Exception.Message
    return $null
}

# If URL is specified
if ($PSCmdlet.ParameterSetName -eq 'PSetSpecified') {
    $siteCollection = [System.Collections.ArrayList]@()
    $URL | ForEach-Object {
        try {
            $null = $siteCollection.Add($(Get-PnPTenantSite -Url $_ -Detailed -ErrorAction Stop))
        }
        catch {
            $_.Exception.Message | Out-Default
        }
    }
}

# If View is specified
if ($PSCmdlet.ParameterSetName -eq 'PSetAll') {
    #Region Build site template lookup table
    ## Get all available site templates
    $ClientContext = Get-PnPContext
    $Web = Get-PnPWeb

    ## Get All Web Templates
    $WebTemplateCollection = $Web.GetAvailableWebTemplates(1033, 0)
    $ClientContext.Load($WebTemplateCollection)
    $ClientContext.ExecuteQuery()

    ## Create a lookup dictionary
    $webTemplateTable = [ordered]@{}
    $WebTemplateCollection | Sort-Object Name | ForEach-Object {
        $webTemplateTable.Add($_.Name, $_.Title)
    }
    #EndRegion

    switch ($View) {
        'All Sites' { $siteCollection = Get-PnPTenantSite -IncludeOneDriveSites | Where-Object { $_.Url -notin $excludedUrls } }
        'SharePoint Sites' { $siteCollection = Get-PnPTenantSite | Where-Object { $_.Url -notin $excludedUrls } }
        'OneDrive Sites' { $siteCollection = Get-PnPTenantSite -IncludeOneDriveSites -Filter "Url -like '-my.sharepoint.com/personal/'" | Where-Object { $_.Url -notin $excludedUrls } }
        'Microsoft 365 Group Sites' { $siteCollection = Get-PnPTenantSite -GroupIdDefined:$true | Where-Object { $_.GroupId -ne '00000000-0000-0000-0000-000000000000' -and $_.Url -notin $excludedUrls } }
        'Sites Without a Group' { $siteCollection = Get-PnPTenantSite -GroupIdDefined:$false | Where-Object { $_.Url -notin $excludedUrls } }
        'Sites Connected to Teams' { $siteCollection = Get-PnPTenantSite -GroupIdDefined:$true | Where-Object { $_.IsTeamsConnected -eq $true -and $_.Url -notin $excludedUrls } }
        'Sites Connected to Teams Channel' { $siteCollection = Get-PnPTenantSite | Where-Object { $_.IsTeamsChannelConnected -and $_.Url -notin $excludedUrls } }
        Default {}
    }
}

"Found $($siteCollection.Count) site(s) ..." | Out-Default

if ($siteCollection.Count -lt 1) {
    return $null
}

$spoSiteStorageUsageResult = [System.Collections.ArrayList]@()

$totSites    = $siteCollection.Count
$CurrentSite = 0
foreach ($spoSite in ($siteCollection | Sort-Object Url)) {
    $currentSite++
    "[$currentSite] Processing $($spoSite.Url) ..." | Out-Default
    $siteAttributes = [System.Collections.ArrayList]@()
    if ($spoSite.GroupId -ne '00000000-0000-0000-0000-000000000000') {
        $null = $siteAttributes.Add('Microsoft 365 Group')
    }
    if ($spoSite.IsTeamsConnected) {
        $null = $siteAttributes.Add('Microsoft Teams')
    }
    if ($spoSite.TeamsChannelType -eq 'PrivateChannel') {
        $null = $siteAttributes.Add('Private Channel')
    }
    if ($spoSite.TeamsChannelType -eq 'SharedChannel') {
        $null = $siteAttributes.Add('Shared Channel')
    }

    $null = $spoSiteStorageUsageResult.Add(
        $([PSCustomObject]@{
                'GroupID'          = $spoSite.GroupID
                'SiteName'         = $spoSite.Title
                'Url'              = $spoSite.Url
                # 'StorageQuota(GB)' = $(($spoSite.StorageQuota * 1MB) / 1GB)
                'StorageUsage(GB)' = $([System.Math]::Round((($spoSite.StorageUsageCurrent * 1MB) / 1GB), 2))
                #'StorageUsage(%)'  = $(
                #    if ($spoSite.StorageUsageCurrent -gt 0) {
                #        $([System.Math]::Round((($spoSite.StorageUsageCurrent / $spoSite.StorageQuota) * 100), 2))
                #    }
                #    else {
                #        0
                #    }
                #)
                'Owner'            = $(
                    if ($SeekOwner -eq $True) {
                        if ($spoSite.Template -like "GROUP*") {
                            $group = Get-PnPMicrosoft365Group -Identity $spoSite.GroupId
                            if ($group.Mail) {
                                "$($group.DisplayName) <$($group.Mail)>"
                            }
                            else {
                                "$($group.DisplayName) <No Email>"
                            }
                        }
                        else {
                            if ($spoSite.Owner) {
                                if ($user = Get-PnPAzureADUser -Identity $spoSite.Owner) {
                                    if ($user.Mail) {
                                        "$($user.DisplayName) <$($user.Mail)>"
                                    }
                                    else {
                                        "$($user.DisplayName) <No Email>"
                                    }
                                }
                            }
                        }
                    }
                )
                'SensitivityLabel' = $spoSite.SensitivityLabel
                'Privacy'          = $( 
                    if ($_.GroupId -ne '00000000-0000-0000-0000-000000000000' -and $_.Url -notin $excludedUrls) {
                        (Get-pnpTeamsTeam -identity $spoSite.GroupID -ErrorAction SilentlyContinue).Visibility 
                    }
                )
                'Template'         = $(
                    if ($spoSite.Url -like "*-my.sharepoint.com/personal/*") {
                        'OneDrive'
                    }
                    else {
                        $webTemplateTable[$($spoSite.Template)]
                    }
                )
                SiteAttributes     = $(
                    if ($siteAttributes.Count -gt 0) {
                        $siteAttributes -join ","
                    }
                )
            }
        )
    )
    $spoSiteStorageUsageResult[$($currentSite-1)] | export-csv -path $OutputFile -Append
}
# $spoSiteStorageUsageResult | export-csv -path $OutputFile
return $spoSiteStorageUsageResult
